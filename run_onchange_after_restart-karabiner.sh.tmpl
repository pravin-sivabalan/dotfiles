#!/bin/bash
# This script restarts Karabiner Elements when configuration files change
# Chezmoi runs this automatically when the hash below changes

# Hash of Karabiner configuration files to detect changes
# {{ include "private_dot_config/private_karabiner/private_assets/private_complex_modifications/global.json" | sha256sum }}

set -e

# Only run on macOS
if [[ "$(uname)" != "Darwin" ]]; then
    echo "Skipping Karabiner Elements restart (not on macOS)"
    exit 0
fi

# Check if Karabiner Elements is installed
if ! command -v karabiner_cli &> /dev/null && [[ ! -d "/Applications/Karabiner-Elements.app" ]]; then
    echo "Karabiner Elements not found, skipping restart"
    exit 0
fi

echo "Restarting Karabiner Elements..."

# Try to restart using launchctl (preferred method)
if launchctl list | grep -q "org.pqrs.karabiner"; then
    # Restart the console user server
    launchctl kickstart -k "gui/$(id -u)/org.pqrs.karabiner.karabiner_console_user_server" 2>/dev/null || true

    # Also restart the main service
    launchctl kickstart -k "gui/$(id -u)/org.pqrs.karabiner.agent" 2>/dev/null || true

    echo "Karabiner Elements restarted successfully"
else
    # Fallback: kill and reopen the application
    if pgrep -x "Karabiner-Elements" > /dev/null; then
        killall "Karabiner-Elements" 2>/dev/null || true
        sleep 1
    fi

    open -a "Karabiner-Elements"
    echo "Karabiner Elements launched"
fi
